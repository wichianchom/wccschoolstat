<!doctype html>
<html lang="th" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ß‡∏¥‡πÄ‡∏ä‡∏µ‡∏¢‡∏£‡∏ä‡∏°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        html, body, * { font-family: 'Kanit', sans-serif !important; }
        .loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.95); display: flex; justify-content: center; align-items: center; z-index: 9999; flex-direction: column; }
        
        @keyframes pulse-soft { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }
        .alert-active { animation: pulse-soft 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }

        /* PRINT SETTINGS */
        @media print {
            @page { size: A4 landscape; margin: 5mm; } 
            body { background: white !important; -webkit-print-color-adjust: exact; zoom: 90%; }
            #app, #login-screen, .toast, #admin-modal, #classroom-modal, #edit-modal, .no-print, #unchecked-alert-box { display: none !important; }
            #print-area { display: block !important; width: 100%; }
            .print-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; align-items: start; }
            .grade-box { break-inside: avoid; page-break-inside: avoid; margin-bottom: 5px; }
            table.print-table { width: 100%; border-collapse: collapse; border: 0.5px solid #000; font-size: 10px; }
            table.print-table th, table.print-table td { border: 0.5px solid #000; padding: 1px 2px; text-align: center; height: 14px; line-height: 1.1; }
            table.print-table th { background-color: #f3f4f6 !important; font-weight: bold; }
            .bg-gray-100 { background-color: #f3f4f6 !important; }
            .bg-blue-50 { background-color: #eff6ff !important; }
            .bg-red-50 { background-color: #fef2f2 !important; }
        }
        #print-area { display: none; }
    </style>
</head>
<body class="h-full bg-blue-50">

    <div id="loading-screen" class="loading-overlay">
        <div class="animate-spin rounded-full h-12 w-12 border-4 border-blue-600 border-t-transparent mb-4"></div>
        <p class="text-blue-800 font-bold text-lg" id="loading-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
    </div>

    <div id="login-screen" class="hidden fixed inset-0 bg-gray-900/50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-sm w-full">
            <h1 class="text-2xl font-bold text-center text-indigo-900 mb-6">‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</h1>
            <form id="login-form" class="space-y-4">
                <input type="password" id="password" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" class="w-full border-2 border-gray-200 p-3 rounded-xl focus:border-indigo-500 outline-none transition">
                <div class="flex gap-2">
                    <button type="submit" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white p-3 rounded-xl font-bold transition">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                    <button type="button" id="cancel-login" class="px-4 bg-gray-200 hover:bg-gray-300 rounded-xl font-bold text-gray-600">‡∏Å‡∏•‡∏±‡∏ö</button>
                </div>
            </form>
        </div>
    </div>

    <div id="app" class="h-full w-full overflow-auto hidden">
        <div class="max-w-7xl mx-auto p-4 md:p-6">
            <div class="bg-white rounded-2xl shadow-sm p-5 mb-6 flex flex-col md:flex-row justify-between items-center gap-4">
                <div>
                    <h1 class="text-3xl font-bold text-indigo-900">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ß‡∏¥‡πÄ‡∏ä‡∏µ‡∏¢‡∏£‡∏ä‡∏°</h1>
                    <p id="curr-date" class="text-gray-500 mt-1"></p>
                </div>
                <div class="flex gap-2">
                    <button id="admin-btn" class="bg-indigo-100 text-indigo-700 hover:bg-indigo-200 px-4 py-2 rounded-lg font-bold transition">üîê Admin Login</button>
                    <button id="logout-btn" class="hidden bg-red-100 text-red-700 hover:bg-red-200 px-4 py-2 rounded-lg font-bold transition">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
                </div>
            </div>

            <div id="unchecked-alert-box" class="hidden bg-red-50 border-l-4 border-red-500 rounded-r-xl shadow-md p-5 mb-6 relative overflow-hidden alert-active">
                <div class="flex items-start gap-4 z-10 relative">
                    <div class="bg-red-100 p-2 rounded-full shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                        </svg>
                    </div>
                    <div class="w-full">
                        <h3 class="text-lg font-bold text-red-800">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ (‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)</h3>
                        <p class="text-sm text-red-600 mt-1 mb-3 font-medium">
                            ‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <span id="current-time-display" class="font-bold bg-red-100 px-2 rounded">--:-- ‡∏ô.</span> ‚Äî ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ:
                        </p>
                        <div class="bg-white border border-red-100 rounded-lg p-3 max-h-48 overflow-y-auto custom-scrollbar">
                            <ul id="unchecked-list" class="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm text-red-700 font-medium"></ul>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-lg p-6 mb-6 no-print border border-indigo-50">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold text-xl text-indigo-900 flex items-center gap-2">
                        üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                    </h3>
                    <div id="admin-tools" class="hidden flex gap-2">
                         <button onclick="autoSetupClassrooms()" class="bg-yellow-100 text-yellow-800 hover:bg-yellow-200 px-3 py-2 rounded-lg text-sm font-bold flex items-center gap-2">
                            ‚ö° ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (56 ‡∏´‡πâ‡∏≠‡∏á)
                        </button>
                        <button id="btn-mng-cls" class="bg-green-100 text-green-800 hover:bg-green-200 px-3 py-2 rounded-lg text-sm font-bold">
                            + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡πâ‡∏≠‡∏á
                        </button>
                    </div>
                </div>

                <form id="abs-form" class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                    <div class="md:col-span-1">
                        <label class="text-sm font-bold text-gray-700 block mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</label>
                        <input type="date" id="r-date" class="w-full border-2 border-gray-200 p-2.5 rounded-lg focus:border-indigo-500 outline-none cursor-pointer">
                    </div>
                    <div class="md:col-span-1">
                        <label class="text-sm font-bold text-gray-700 block mb-1">‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                        <select id="r-cls" class="w-full border-2 border-gray-200 p-2.5 rounded-lg focus:border-indigo-500 outline-none bg-white font-medium">
                            <option value="">-- ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î --</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-sm font-bold text-gray-700 block mb-1">‡∏ä‡∏≤‡∏¢ (‡∏Ç‡∏≤‡∏î)</label>
                        <input type="number" id="r-m" value="0" min="0" class="w-full border-2 border-gray-200 p-2.5 rounded-lg focus:border-indigo-500 outline-none text-center font-bold text-lg">
                    </div>
                    <div>
                        <label class="text-sm font-bold text-gray-700 block mb-1">‡∏´‡∏ç‡∏¥‡∏á (‡∏Ç‡∏≤‡∏î)</label>
                        <input type="number" id="r-f" value="0" min="0" class="w-full border-2 border-gray-200 p-2.5 rounded-lg focus:border-indigo-500 outline-none text-center font-bold text-lg">
                    </div>
                    <div class="md:col-span-1">
                        <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white p-2.5 rounded-lg font-bold shadow-lg shadow-indigo-200 transition">
                            ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                        </button>
                    </div>
                </form>
            </div>

            <div id="stats-panel" class="hidden">
                <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                    <h3 class="font-bold text-xl text-gray-800">üìä ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î Admin</h3>
                    <div class="flex gap-2 items-center bg-white p-2 rounded-lg shadow-sm">
                        <span class="text-sm font-bold text-gray-600 pl-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</span>
                        <input type="date" id="v-date" class="border p-1 rounded text-sm">
                        <button onclick="printReport()" class="bg-gray-800 hover:bg-black text-white px-4 py-1.5 rounded text-sm font-bold flex items-center gap-2">
                            üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-5 rounded-2xl shadow-lg">
                        <div class="text-sm opacity-90">‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                        <div id="s-total" class="text-3xl font-bold mt-1">0</div>
                        <div class="text-xs mt-2 bg-blue-700/30 p-1 rounded inline-block" id="s-total-detail">‡∏ä: 0 / ‡∏ç: 0</div>
                    </div>
                    <div class="bg-gradient-to-br from-emerald-500 to-emerald-600 text-white p-5 rounded-2xl shadow-lg">
                        <div class="text-sm opacity-90">‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>
                        <div id="s-pres" class="text-3xl font-bold mt-1">0</div>
                        <div class="text-xs mt-2 bg-emerald-700/30 p-1 rounded inline-block" id="s-pres-detail">‡∏ä: 0 / ‡∏ç: 0</div>
                    </div>
                    <div class="bg-gradient-to-br from-rose-500 to-rose-600 text-white p-5 rounded-2xl shadow-lg">
                        <div class="text-sm opacity-90">‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>
                        <div id="s-abs" class="text-3xl font-bold mt-1">0</div>
                        <div class="text-xs mt-2 bg-rose-700/30 p-1 rounded inline-block" id="s-abs-detail">‡∏ä: 0 / ‡∏ç: 0</div>
                    </div>
                    <div class="bg-gradient-to-br from-orange-400 to-orange-500 text-white p-5 rounded-2xl shadow-lg">
                        <div class="text-sm opacity-90">% ‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏î</div>
                        <div id="s-perc" class="text-3xl font-bold mt-1">0%</div>
                        <div class="text-xs mt-2 text-orange-100">‡∏Ç‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-lg overflow-hidden border border-gray-100">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-center">
                            <thead class="bg-gray-50 text-gray-600 uppercase text-xs tracking-wider border-b">
                                <tr>
                                    <th class="p-4 text-left font-bold">‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
                                    <th class="p-4 font-bold">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                    <th class="p-4 font-bold">‡∏ô‡∏£.‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ä/‡∏ç)</th>
                                    <th class="p-4 font-bold text-red-600">‡∏Ç‡∏≤‡∏î (‡∏Ñ‡∏ô)</th>
                                    <th class="p-4 font-bold">% ‡∏Ç‡∏≤‡∏î</th>
                                    <th class="p-4 font-bold">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                </tr>
                            </thead>
                            <tbody id="tbl-body" class="divide-y divide-gray-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="print-area">
        <div class="flex justify-between items-center mb-2 px-2">
             <h1 class="text-md font-bold">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ß‡∏¥‡πÄ‡∏ä‡∏µ‡∏¢‡∏£‡∏ä‡∏°</h1>
             <div class="text-xs font-bold" id="print-date"></div>
        </div>
        <div id="print-grid" class="print-grid"></div>
        <div class="mt-2 flex justify-end">
            <div style="width: 45%;">
                <table class="print-table">
                    <thead>
                        <tr>
                            <th rowspan="2">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
                            <th colspan="3">‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
                            <th colspan="3">‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
                            <th colspan="3">‡∏Ç‡∏≤‡∏î</th>
                        </tr>
                        <tr><th>‡∏ä</th><th>‡∏ç</th><th>‡∏£‡∏ß‡∏°</th><th>‡∏ä</th><th>‡∏ç</th><th>‡∏£‡∏ß‡∏°</th><th>‡∏ä</th><th>‡∏ç</th><th>‡∏£‡∏ß‡∏°</th></tr>
                    </thead>
                    <tbody id="print-total"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="cls-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-2xl w-full max-w-sm shadow-2xl">
            <h3 class="font-bold text-xl mb-4 text-indigo-900">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà</h3>
            <input id="new-cls-n" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á (‡πÄ‡∏ä‡πà‡∏ô ‡∏õ.1/1)" class="w-full border-2 p-3 mb-3 rounded-xl outline-none focus:border-indigo-500">
            <div class="flex gap-3 mb-4">
                <input id="new-cls-m" type="number" placeholder="‡∏ä‡∏≤‡∏¢" class="w-full border-2 p-3 rounded-xl outline-none focus:border-indigo-500">
                <input id="new-cls-f" type="number" placeholder="‡∏´‡∏ç‡∏¥‡∏á" class="w-full border-2 p-3 rounded-xl outline-none focus:border-indigo-500">
            </div>
            <button onclick="addClassroom()" class="w-full bg-green-600 hover:bg-green-700 text-white p-3 rounded-xl font-bold transition">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            <button onclick="$('cls-modal').classList.add('hidden')" class="w-full mt-3 text-gray-500 text-sm font-bold">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
        </div>
    </div>

    <div id="edit-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-2xl w-full max-w-sm shadow-2xl border-4 border-yellow-100">
            <h3 class="font-bold text-xl mb-4 text-yellow-700">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
            <input type="hidden" id="edit-cls-id">
            <label class="text-xs font-bold text-gray-500">‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á</label>
            <input id="edit-cls-n" class="w-full border-2 p-2 mb-3 rounded-lg outline-none bg-gray-50 font-bold text-gray-700">
            <div class="flex gap-3 mb-4">
                <div class="w-1/2">
                    <label class="text-xs font-bold text-gray-500">‡∏ä‡∏≤‡∏¢ (‡∏Ñ‡∏ô)</label>
                    <input id="edit-cls-m" type="number" class="w-full border-2 p-2 rounded-lg outline-none focus:border-yellow-500 font-bold text-center">
                </div>
                <div class="w-1/2">
                    <label class="text-xs font-bold text-gray-500">‡∏´‡∏ç‡∏¥‡∏á (‡∏Ñ‡∏ô)</label>
                    <input id="edit-cls-f" type="number" class="w-full border-2 p-2 rounded-lg outline-none focus:border-yellow-500 font-bold text-center">
                </div>
            </div>
            <button onclick="saveEditClassroom()" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white p-3 rounded-xl font-bold transition">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
            <button onclick="$('edit-modal').classList.add('hidden')" class="w-full mt-3 text-gray-500 text-sm font-bold">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>
    </div>

    <script>
        // ============================================
        // ‚ö†Ô∏è ‡∏ß‡∏≤‡∏á URL ‡∏Ç‡∏≠‡∏á Google Apps Script ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
        // ============================================
        const API_URL = "https://script.google.com/macros/s/AKfycbzUC8jlNhkYbAW-7QH-s8RHHZsomOS7EWfQuH1l2guo4WFhANkoYf5UUF_g2Ol7mGjq/exec"; 
        
        // Corrected Data (Total 994 M / 989 F = 1983)
        const classroomsDataFromImage = [
          {c:"‡∏≠.3/1", m:15, f:15}, {c:"‡∏≠.3/2", m:14, f:16}, {c:"‡∏≠.3/3", m:18, f:12}, {c:"‡∏≠.3/4", m:14, f:14}, {c:"‡∏≠.3/5", m:15, f:10},
          {c:"‡∏õ.1/1", m:20, f:18}, {c:"‡∏õ.1/2", m:20, f:20}, {c:"‡∏õ.1/3", m:17, f:21}, {c:"‡∏õ.1/4", m:18, f:20}, {c:"‡∏õ.1/5", m:19, f:18}, {c:"‡∏õ.1/6", m:19, f:17}, {c:"‡∏õ.1/7", m:14, f:16}, {c:"‡∏õ.1/8", m:14, f:15},
          {c:"‡∏õ.2/1", m:26, f:14}, {c:"‡∏õ.2/2", m:23, f:17}, {c:"‡∏õ.2/3", m:21, f:19}, {c:"‡∏õ.2/4", m:22, f:17}, {c:"‡∏õ.2/5", m:23, f:16}, {c:"‡∏õ.2/6", m:23, f:16}, {c:"‡∏õ.2/7", m:14, f:16}, {c:"‡∏õ.2/8", m:16, f:14},
          {c:"‡∏õ.3/1", m:19, f:22}, {c:"‡∏õ.3/2", m:23, f:20}, {c:"‡∏õ.3/3", m:21, f:18}, {c:"‡∏õ.3/4", m:20, f:21}, {c:"‡∏õ.3/5", m:23, f:19}, {c:"‡∏õ.3/6", m:22, f:19}, {c:"‡∏õ.3/7", m:12, f:18}, {c:"‡∏õ.3/8", m:11, f:19},
          {c:"‡∏õ.4/1", m:21, f:17}, {c:"‡∏õ.4/2", m:19, f:19}, {c:"‡∏õ.4/3", m:17, f:21}, {c:"‡∏õ.4/4", m:20, f:18}, {c:"‡∏õ.4/5", m:20, f:18}, {c:"‡∏õ.4/6", m:18, f:20}, {c:"‡∏õ.4/7", m:14, f:13}, {c:"‡∏õ.4/8", m:13, f:15}, {c:"‡∏õ.4/9", m:12, f:24},
          {c:"‡∏õ.5/1", m:22, f:19}, {c:"‡∏õ.5/2", m:21, f:20}, {c:"‡∏õ.5/3", m:21, f:20}, {c:"‡∏õ.5/4", m:21, f:20}, {c:"‡∏õ.5/5", m:20, f:20}, {c:"‡∏õ.5/6", m:22, f:19}, {c:"‡∏õ.5/7", m:7, f:10}, {c:"‡∏õ.5/8", m:6, f:12}, {c:"‡∏õ.5/9", m:11, f:25},
          {c:"‡∏õ.6/1", m:21, f:18}, {c:"‡∏õ.6/2", m:17, f:19}, {c:"‡∏õ.6/3", m:18, f:19}, {c:"‡∏õ.6/4", m:19, f:16}, {c:"‡∏õ.6/5", m:18, f:18}, {c:"‡∏õ.6/6", m:19, f:19}, {c:"‡∏õ.6/7", m:13, f:12}, {c:"‡∏õ.6/8", m:12, f:15}, {c:"‡∏õ.6/9", m:14, f:22}
        ];

        let data = { records: [], classrooms: [], admins: [] };
        let user = 'teacher';
        
        const getLocalTodayDate = () => {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };
        let selDate = getLocalTodayDate();

        const $ = (id) => document.getElementById(id);

        const sortCls = (strA, strB) => {
            const a = String(strA || "");
            const b = String(strB || "");
            const prefixA = a.substring(0, 1);
            const prefixB = b.substring(0, 1);
            if (prefixA === '‡∏≠' && prefixB !== '‡∏≠') return -1;
            if (prefixA !== '‡∏≠' && prefixB === '‡∏≠') return 1;
            return a.localeCompare(b, 'th', {numeric: true});
        };

        setInterval(() => {
            const now = new Date();
            const timeStr = `${now.getHours()}:${String(now.getMinutes()).padStart(2,'0')} ‡∏ô.`;
            if($('current-time-display')) $('current-time-display').innerText = timeStr;
        }, 1000);

        async function loadData() {
            $('loading-screen').classList.remove('hidden');
            $('loading-text').innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";
            try {
                if(API_URL.includes("‡∏ß‡∏≤‡∏á_URL")) throw new Error("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ô‡∏≥ URL ‡∏à‡∏≤‡∏Å Google Script ‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
                const res = await fetch(API_URL);
                data = await res.json();
                render();
            } catch(e) { alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + e.message); }
            $('loading-screen').classList.add('hidden');
            $('app').classList.remove('hidden');
        }

        async function postData(action, type, payload) {
            $('loading-screen').classList.remove('hidden');
            $('loading-text').innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";
            try {
                await fetch(API_URL, {
                    method: 'POST', mode: 'no-cors',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ action, type, data: payload, id: payload.id })
                });
                await new Promise(r => setTimeout(r, 1500));
                await loadData();
                if(action !== 'setupClassrooms') alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
            } catch(e) { alert("‚ùå ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + e.message); }
            $('loading-screen').classList.add('hidden');
        }

        async function autoSetupClassrooms() {
            if(!confirm(`‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 56 ‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà? (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡πâ‡∏≤‡∏á)`)) return;
            const payload = classroomsDataFromImage.map((room, idx) => ({ id: `C_AUTO_${idx}`, classroom: room.c, m: room.m, f: room.f }));
            $('loading-screen').classList.remove('hidden');
            $('loading-text').innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á...";
            try {
                await fetch(API_URL, {
                    method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ action: 'setupClassrooms', data: payload })
                });
                await new Promise(r => setTimeout(r, 2000));
                await loadData();
                alert("‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô");
            } catch(e) { alert("‚ùå ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + e.message); }
            $('loading-screen').classList.add('hidden');
        }

        function render() {
            const todayStr = getLocalTodayDate();
            const inputDate = $('r-date').value || todayStr;
            const recsOnDate = data.records.filter(r => r.date === inputDate);

            // Alert Logic
            const checkedSet = new Set(recsOnDate.map(r => r.classroom));
            const uncheckedClassrooms = data.classrooms.filter(c => !checkedSet.has(c.classroom));
            const currentHour = new Date().getHours();
            
            if(uncheckedClassrooms.length > 0 && (inputDate === todayStr) && (currentHour >= 12)) {
                $('unchecked-alert-box').classList.remove('hidden');
                $('unchecked-list').innerHTML = uncheckedClassrooms.sort(sortCls).map(c => 
                    `<li class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-red-400"></span>${c.classroom} (${parseInt(c.m)+parseInt(c.f)} ‡∏Ñ‡∏ô)</li>`
                ).join('');
            } else {
                $('unchecked-alert-box').classList.add('hidden');
            }

            // Dropdown
            const clsSel = $('r-cls');
            const currCls = clsSel.value;
            if(data.classrooms.length === 0) {
                 clsSel.innerHTML = '<option value="">(‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô)</option>';
            } else {
                const options = data.classrooms.sort(sortCls).map(c => {
                    const isChecked = checkedSet.has(c.classroom);
                    return `<option value="${c.classroom}">${isChecked ? '‚úÖ' : 'üî¥'} ${c.classroom}</option>`;
                }).join('');
                clsSel.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô --</option>' + options;
                clsSel.value = currCls;
            }

            // Admin Table
            if(user === 'admin') {
                const viewDate = $('v-date').value;
                const viewRecs = data.records.filter(r => r.date === viewDate);
                let t = {m:0, f:0, abs:0, pm:0, pf:0, abs_m:0, abs_f:0};
                
                const html = data.classrooms.sort(sortCls).map(c => {
                    const rec = viewRecs.find(r => r.classroom === c.classroom);
                    const std = parseInt(c.m)+parseInt(c.f);
                    
                    t.m += parseInt(c.m); 
                    t.f += parseInt(c.f);
                    
                    const abs = rec ? (parseInt(rec.abs_m)+parseInt(rec.abs_f)) : 0;
                    if(rec) {
                        t.abs += abs;
                        t.abs_m += parseInt(rec.abs_m);
                        t.abs_f += parseInt(rec.abs_f);
                    }
                    const percent = std > 0 && rec ? ((abs/std)*100).toFixed(0) : 0;
                    const statusBadge = rec 
                        ? `<span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold border border-green-200">‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ‡πÅ‡∏•‡πâ‡∏ß</span>` 
                        : `<span class="bg-red-100 text-red-700 px-2 py-1 rounded text-xs font-bold border border-red-200">‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡πá‡∏Ñ</span>`;

                    return `<tr class="${rec ? 'hover:bg-gray-50' : 'bg-red-50 hover:bg-red-100'} border-b transition">
                        <td class="p-3 text-left font-semibold text-gray-700">${c.classroom}</td>
                        <td class="p-3">${statusBadge}</td>
                        <td class="p-3 text-gray-600 font-bold">${std} <span class="text-xs font-normal text-gray-400 block">(‡∏ä ${c.m} / ‡∏ç ${c.f})</span></td>
                        <td class="p-3 font-bold ${rec ? 'text-red-600' : 'text-gray-400'}">${rec ? abs : '-'}</td>
                        <td class="p-3 font-bold text-gray-600">${rec ? percent+'%' : '-'}</td>
                        <td class="p-3 flex gap-1 justify-center">
                            ${rec ? `<button onclick="delRec('${rec.id}')" class="text-red-500 bg-white border border-red-200 px-2 py-1 rounded text-xs">‡∏•‡∏ö</button>` : ''}
                            <button onclick="openEditModal('${c.id}')" class="text-yellow-600 bg-white border border-yellow-200 px-2 py-1 rounded text-xs">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                        </td>
                    </tr>`;
                }).join('');
                
                $('tbl-body').innerHTML = html;
                const totalStd = t.m + t.f;
                const totalPres = totalStd - t.abs;
                const presM = t.m - t.abs_m;
                const presF = t.f - t.abs_f;

                $('s-total').innerText = totalStd;
                $('s-total-detail').innerText = `‡∏ä: ${t.m} / ‡∏ç: ${t.f}`;
                $('s-pres').innerText = totalPres;
                $('s-pres-detail').innerText = `‡∏ä: ${presM} / ‡∏ç: ${presF}`;
                $('s-abs').innerText = t.abs;
                $('s-abs-detail').innerText = `‡∏ä: ${t.abs_m} / ‡∏ç: ${t.abs_f}`;
                $('s-perc').innerText = totalStd > 0 ? ((t.abs/totalStd)*100).toFixed(1)+'%' : '0%';
            }

            const d = new Date(selDate);
            $('curr-date').innerText = `‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()+543}`;
        }

        // --- EDIT FUNCTIONS ---
        function openEditModal(id) {
            const cls = data.classrooms.find(c => c.id === id);
            if(!cls) return;
            $('edit-cls-id').value = cls.id;
            $('edit-cls-n').value = cls.classroom;
            $('edit-cls-m').value = cls.m;
            $('edit-cls-f').value = cls.f;
            $('edit-modal').classList.remove('hidden');
        }

        function saveEditClassroom() {
            const id = $('edit-cls-id').value;
            const name = $('edit-cls-n').value;
            const m = $('edit-cls-m').value;
            const f = $('edit-cls-f').value;
            
            if(!name || !m || !f) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
            
            postData('update', 'classroom', { id: id, classroom: name, m: m, f: f });
            $('edit-modal').classList.add('hidden');
        }

        // Handlers
        $('r-date').onchange = (e) => { render(); };
        $('abs-form').onsubmit = (e) => {
            e.preventDefault();
            const cls = $('r-cls').value;
            if(!cls) return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô');
            const rec = data.records.find(r => r.date === $('r-date').value && r.classroom === cls);
            if(rec) return alert('‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏ä‡πá‡∏Ñ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß');
            postData('create', 'record', { id: 'R'+Date.now(), date: $('r-date').value, classroom: cls, abs_m: $('r-m').value, abs_f: $('r-f').value });
            $('r-m').value=0; $('r-f').value=0;
        };
        function addClassroom() { postData('create', 'classroom', { id:'C'+Date.now(), classroom:$('new-cls-n').value, m:$('new-cls-m').value, f:$('new-cls-f').value }); $('cls-modal').classList.add('hidden'); }
        function delRec(id) { if(confirm('‡∏•‡∏ö?')) postData('delete', 'record', {id: id}); }
        $('login-form').onsubmit = (e) => { e.preventDefault(); if($('password').value==='admin123' || data.admins.some(a=>a.password===$('password').value)) { user='admin'; $('login-screen').classList.add('hidden'); updRole(); } else alert('‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏¥‡∏î'); };
        function updRole() {
            const isAdmin = user==='admin'; $('stats-panel').classList.toggle('hidden', !isAdmin); $('admin-tools').classList.toggle('hidden', !isAdmin); $('admin-btn').classList.toggle('hidden', isAdmin); $('logout-btn').classList.toggle('hidden', !isAdmin); $('v-date').value = $('r-date').value; render();
        }
        $('admin-btn').onclick = () => $('login-screen').classList.remove('hidden');
        $('cancel-login').onclick = () => $('login-screen').classList.add('hidden');
        $('logout-btn').onclick = () => { user='teacher'; updRole(); };
        $('v-date').onchange = () => render();
        $('r-date').value = selDate; $('v-date').value = selDate;
        $('btn-mng-cls').onclick = () => $('cls-modal').classList.remove('hidden');

        // PRINT LOGIC (FIXED COLUMN SHIFT)
        window.printReport = () => {
            const viewDate = $('v-date').value;
            const grid = $('print-grid'); grid.innerHTML = '';
            const recs = data.records.filter(r => r.date === viewDate);
            const groups = {};
            data.classrooms.forEach(c => { const g = (c.classroom.match(/^([^\d]+\d+)/) || [null,'‡∏≠‡∏∑‡πà‡∏ô‡πÜ'])[1]; if(!groups[g]) groups[g]=[]; groups[g].push(c); });
            let GT = {m:0, f:0, s:0, pm:0, pf:0, ps:0, am:0, af:0, as:0};

            Object.keys(groups).sort(sortCls).forEach(gName => {
                let rows = '', ST = {m:0,f:0,s:0, am:0,af:0,as:0, pm:0,pf:0,ps:0};
                groups[gName].sort((a,b)=>sortCls(a.classroom,b.classroom)).forEach(c => {
                    const r = recs.find(x => x.classroom === c.classroom);
                    const sm=parseInt(c.m), sf=parseInt(c.f), ss=sm+sf;
                    const am=r?parseInt(r.abs_m):0, af=r?parseInt(r.abs_f):0, as=am+af;
                    const pm=sm-am, pf=sf-af, ps=ss-as;
                    ST.m+=sm; ST.f+=sf; ST.s+=ss; ST.am+=am; ST.af+=af; ST.as+=as; ST.pm+=pm; ST.pf+=pf; ST.ps+=ps;
                    rows += `<tr><td>${c.classroom}</td><td>${sm}</td><td>${sf}</td><td class="bg-gray-100">${ss}</td><td>${pm}</td><td>${pf}</td><td class="bg-blue-50">${ps}</td><td>${am}</td><td>${af}</td><td class="bg-red-50 font-bold">${as}</td></tr>`;
                });
                GT.m+=ST.m; GT.f+=ST.f; GT.s+=ST.s; GT.pm+=ST.pm; GT.pf+=ST.pf; GT.ps+=ST.ps; GT.am+=ST.am; GT.af+=ST.af; GT.as+=ST.as;
                grid.innerHTML += `<div class="grade-box"><table class="print-table"><thead><tr class="header-present"><th rowspan="2">‡∏ä‡∏±‡πâ‡∏ô ${gName}</th><th colspan="3">‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th><th colspan="3">‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th><th colspan="3" class="header-absent">‡∏Ç‡∏≤‡∏î</th></tr><tr><th>‡∏ä</th><th>‡∏ç</th><th>‡∏£‡∏ß‡∏°</th><th>‡∏ä</th><th>‡∏ç</th><th>‡∏£‡∏ß‡∏°</th><th>‡∏ä</th><th>‡∏ç</th><th>‡∏£‡∏ß‡∏°</th></tr></thead><tbody>${rows}<tr class="font-bold bg-gray-100"><td>‡∏£‡∏ß‡∏°</td><td>${ST.m}</td><td>${ST.f}</td><td>${ST.s}</td><td>${ST.pm}</td><td>${ST.pf}</td><td>${ST.ps}</td><td>${ST.am}</td><td>${ST.af}</td><td>${ST.as}</td></tr></tbody></table></div>`;
            });
            // ‚úÖ FIX: Added GT.s (Total) as the first cell to match the "Total School" header column
            $('print-total').innerHTML = `<tr class="text-center font-bold"><td>${GT.s}</td><td>${GT.m}</td><td>${GT.f}</td><td>${GT.s}</td><td>${GT.pm}</td><td>${GT.pf}</td><td>${GT.ps}</td><td>${GT.am}</td><td>${GT.af}</td><td>${GT.as}</td></tr>`;
            
            const d = new Date(viewDate);
            const y = d.getFullYear() + 543;
            const m = d.getMonth();
            const day = d.getDate();
            const thaiMonths = ['‡∏°.‡∏Ñ.','‡∏Å.‡∏û.','‡∏°‡∏µ.‡∏Ñ.','‡πÄ‡∏°.‡∏¢.','‡∏û.‡∏Ñ.','‡∏°‡∏¥.‡∏¢.','‡∏Å.‡∏Ñ.','‡∏™.‡∏Ñ.','‡∏Å.‡∏¢.','‡∏ï.‡∏Ñ.','‡∏û.‡∏¢.','‡∏ò.‡∏Ñ.'];
            $('print-date').innerText = `‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${day} ${thaiMonths[m]} ${y}`;
            
            window.print();
        };

        loadData();
    </script>
</body>
</html>